---
title: How to submit a NONMEM job to slurm
description: A guide for submit_nonmem_model.
pagefind: true
---
import { Card, CardGrid } from '@astrojs/starlight/components';
import { Code } from '@astrojs/starlight/components';

# Overview

This guide describes how to submit a NONMEM job to slurm from R. To do this we will use the `submit_nonmem_model` function. 

## Needed Files
<Card>
<Code 
code={
    `#!/bin/bash
#SBATCH --job-name="{{job_name}}"
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task={{ncpu}}
#SBATCH --partition={{partition}}
#SBATCH --account={{project_name}}

#{{project_path}}
unset SLURM_NODELIST
unset SLURM_JOB_NODELIST
unset SLURM_JOB_USER
unset SLURM_TASKS_PER_NODE
unset SLURM_JOB_UID
unset SLURM_TASK_PID
unset SLURM_LOCALID
unset SLURM_SUBMIT_DIR
unset SLURMD_NODENAME
unset SLURM_NODE_ALIASES
unset SLURM_CLUSTER_NAME
unset SLURM_CPUS_ON_NODE
unset SLURM_JOB_CPUS_PER_NODE
unset SLURM_GTIDS
unset SLURM_JOB_PARTITION
unset SLURM_JOB_NUM_NODES
unset SLURM_JOBID
unset SLURM_PROCID
unset SLURM_TOPOLOGY_ADDR
unset SLURM_TOPOLOGY_ADDR_PATTERN
unset SLURM_WORKING_CLUSTER
unset SLURM_NODELIST
unset SLURM_PRIO_PROCESS
unset SLURM_NNODES
unset SLURM_SUBMIT_HOST
unset SLURM_JOB_ID
unset SLURM_NODEID
unset SLURM_CONF
unset SLURM_JOB_NAME
unset SLURM_JOB_GID
unset SLURM_JOB_NODELIST

# submit_nonmem_model uses the whisker package to populate template files
# https://github.com/edwindj/whisker
{{#parallel}}
{{bbi_exe_path}} nonmem run local {{model_path}}.mod --parallel --threads={{ncpu}} --config {{bbi_config_path}}
{{/parallel}}


{{^parallel}}
{{bbi_exe_path}} nonmem run local {{model_path}}.mod --config {{bbi_config_path}}
{{/parallel}}`
}
lang="bash" title="slurm-job.tmpl"
/>
</Card>
<Card>
<Code 
code={
    `$PROBLEM NM TRIANING BASE MODEL
;DV: mcg/mL
;TIME: day
;CL  : L/d
;VC   : L

$DATA ../../data/derived/PK_Data_v01.csv IGNORE = @

$INPUT C LINE ID TIME AMT RATE DV EVID MDV CMT LLOQ BLQ DOSEN COHORT BWT BAGE BALB SEXF RACEN COHORTC=DROP SEXC=DROP RACEC=DROP

$SUBROUTINE ADVAN6 TRANS1 TOL=6 ;general DiffEq solver

$MODEL
  COMP = (CENTRAL) ;central: CMT = 1

$PK
TVCL = THETA(1) ;Typical value clearance
CL = TVCL * EXP(ETA(1)) ;Individual clearance value

TVVC = THETA(2) ;Typical value central compartment volume
VC = TVVC * EXP(ETA(2)) ;Individual Vc

S1 = VC * 1; mg/L == ug/mL

K10 = CL / VC ; clearance rate, (L/d / L = 1/d)

$DES
DADT(1) = -K10*A(1)

$ERROR (OBSERVATION ONLY)
IPRED = F
W = SQRT(SIGMA(1)*F*F + SIGMA(2)) ;variance on (y = F + eps(1) + Feps(2))
IRES = DV-IPRED
IWRES = IRES/W
Y = IPRED * (1 + EPS(1)) + EPS(2)

$THETA
(0, 1.5)  ;1 CL (L/d)
(0, 20)   ;2 VC (L)

$OMEGA
0.09     ;11 IIV on CL: 30% CV on CL (%CV/100)^2 = sigma_CL^2
0.2025   ;12 IIV on VC: 45% CV on Vc (%CV/100)^2 = sigma_Vc^2

$SIGMA
0.05      ; PROPORTIONAL ERROR
0.05      ; ADDITIVE ERROR

$ESTIMATION METHOD=1 MAXEVAL=9999 PRINT=5 NOABORT

$COV PRINT=E MATRIX=S ;prints eigenvalues of variance-covariance matrix for condition number lambda_n/1

$TABLE LINE ID TIME EVID DV PRED IPRED WRES CWRES IWRES NOPRINT NOAPPEND ONEHEADER FILE=run1001.tab
$TABLE ID ETAS(1:LAST) NOPRINT NOAPPEND ONEHEADER NOTITLE FIRSTONLY FILE=run1001-param.tab`
}
lang="bash" title="1001.mod"
/>
</Card>
